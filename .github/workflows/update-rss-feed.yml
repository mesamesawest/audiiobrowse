name: Update RSS Feed

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  update-rss:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: List files (debug)
      run: |
        echo "Current directory:"
        pwd
        echo "Files in root:"
        ls -la
        echo "Looking for Python script:"
        find . -name "audiio_rss_generator.py" -type f
    
    - name: Generate RSS feed
      run: |
        if [ -f "audiio_rss_generator.py" ]; then
          echo "Found script in root, running..."
          python3 audiio_rss_generator.py
        elif [ -f "audiiobrowse/audiio_rss_generator.py" ]; then
          echo "Found script in audiiobrowse/, running..."
          cd audiiobrowse
          python3 audiio_rss_generator.py
        else
          echo "ERROR: Could not find audiio_rss_generator.py"
          echo "Available files:"
          ls -la
          exit 1
        fi
    
    - name: Check if RSS file was created
      run: |
        if [ -f "audiio_browse.rss" ]; then
          echo "RSS file found in root"
          ls -lh audiio_browse.rss
        elif [ -f "audiiobrowse/audiio_browse.rss" ]; then
          echo "RSS file found in audiiobrowse/"
          ls -lh audiiobrowse/audiio_browse.rss
        else
          echo "ERROR: RSS file was not created!"
          exit 1
        fi
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        if [ -f "audiio_browse.rss" ]; then
          git add audiio_browse.rss
        elif [ -f "audiiobrowse/audiio_browse.rss" ]; then
          git add audiiobrowse/audiio_browse.rss
        fi
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Auto-update RSS feed - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
